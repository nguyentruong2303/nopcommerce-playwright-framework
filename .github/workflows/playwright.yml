name: Playwright Tests
on:
  push:
    branches: [ main, master, fix-ci]
  pull_request:
    branches: [ main, master, fix-ci]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Create nopCommerce Database
      run: |
        echo "Waiting for SQL Server to be ready..."
        sleep 20
        
        echo "Creating database..."
        docker exec $(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest") \
          /opt/mssql-tools18/bin/sqlcmd \
          -S localhost -U sa -P "Can@922946" \
          -Q "CREATE DATABASE [nopCommerce];" \
          -C

    - name: Start nopCommerce Container
      run: |
        sleep 20
        
        docker run -d \
          --name nop_app \
          --network host \
          nopcommerceteam/nopcommerce:latest
        
        echo "Waiting for nopCommerce to start..."
        sleep 30

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Automate Installation with Playwright
      run: |
        cat > install.mjs << 'EOF'
        import { chromium } from '@playwright/test';

        (async () => {
          const browser = await chromium.launch();
          const page = await browser.newPage();
          
          try {
            console.log('Opening installation page...');
            await page.goto('http://localhost:80/install', { waitUntil: 'domcontentloaded', timeout: 60000 });
            
            await page.waitForSelector('select#DataProvider', { state: 'visible', timeout: 10000 });
            
            console.log('Filling database information...');
            await page.selectOption('select#DataProvider', '1');
            await page.waitForTimeout(2000);
            
            console.log('Filling connection details...');
            await page.fill('input#ServerName', 'localhost');
            await page.fill('input#DatabaseName', 'nopCommerce');
            
            const integratedAuth = page.locator('input#IntegratedSecurity');
            if (await integratedAuth.isChecked()) {
              await integratedAuth.uncheck();
              await page.waitForTimeout(500);
            }
            
            await page.fill('input#Username', 'sa');
            await page.fill('input#Password', 'Can@922946');
            
            const trustCert = page.locator('input#TrustServerCertificate');
            if (await trustCert.count() > 0) {
              await trustCert.check();
            }
            
            console.log('Filling admin information...');
            await page.fill('input#AdminEmail', 'admin@yourstore.com');
            await page.fill('input#AdminPassword', 'admin123');
            await page.fill('input#ConfirmPassword', 'admin123');
            
            console.log('Enabling sample data...');
            const sampleDataCheckbox = page.locator('input#InstallSampleData');
            if (await sampleDataCheckbox.count() > 0) {
              await sampleDataCheckbox.check();
            }
            
            console.log('Submitting installation form...');
            const submitButton = page.locator('button[type="submit"].btn-install');
            await submitButton.click();
            
            // Wait a moment to ensure form submission started
            await page.waitForTimeout(5000);
            
            // Check for immediate validation errors
            if (page.url().includes('/install')) {
              const errorMessages = await page.$$eval('.field-validation-error, .validation-summary-errors li', 
                errors => errors.map(e => e.textContent.trim()).filter(t => t.length > 0)
              );
              if (errorMessages.length > 0) {
                console.error('❌ Validation errors found:', errorMessages);
                await browser.close();
                process.exit(1);
              }
            }
            
            console.log('✅ Form submitted successfully! Installation is processing...');
            await browser.close();
            process.exit(0);
          } catch (error) {
            console.error('❌ Form submission failed:', error.message);
            await page.screenshot({ path: 'installation-error.png', fullPage: true });
            await browser.close();
            process.exit(1);
          }
        })();
        EOF
        
        node install.mjs

    - name: Wait for Installation to Complete
      run: |
        echo "⏳ Waiting for nopCommerce installation (can take 3-5 minutes for schema + sample data)..."
        echo "The app may be unresponsive during this time - this is normal."
        
        # Give it time to start the heavy database work
        sleep 30
        
        for i in {1..50}; do
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:80 2>/dev/null || echo "000")
          
          if [ "$STATUS" == "200" ]; then
            if curl -s http://localhost:80 | grep -q "ico-register"; then
              echo "✅ Installation complete! nopCommerce is ready."
              exit 0
            fi
          fi
          
          echo "[$i/50] Status: $STATUS (installation in progress...)"
          
          # If status is 000, container might have crashed
          if [ "$STATUS" == "000" ]; then
            echo "⚠️  Warning: App not responding, checking logs..."
            docker logs nop_app --tail 10
          fi
          
          sleep 15
        done
        
        echo "❌ Installation timeout after 12+ minutes"
        docker logs nop_app --tail 100
        exit 1

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80

# THÊM ĐOẠN NÀY VÀO CUỐI FILE
    - name: Upload Playwright report
      if: always() # Luôn chạy kể cả khi test fail
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: test-results/ # Hoặc playwright-report/ tùy cấu hình của bạn
        retention-days: 7