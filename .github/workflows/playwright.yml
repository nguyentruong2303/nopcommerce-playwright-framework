name: Playwright Tests
on:
  push:
    branches: [ main, master, fix-ci]
  pull_request:
    branches: [ main, master, fix-ci]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Install nopCommerce via Installation Wizard (API)
      run: |
        sleep 20
        
        # Chạy container tạm để vào trang Install
        docker run -d \
          --name nop_app \
          --network host \
          nopcommerceteam/nopcommerce:latest
        
        echo "Waiting for app to start..."
        sleep 30
        
        # Gọi API Install tự động
        curl -X POST http://localhost:80/install \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "DbProvider=sqlserver" \
          -d "DataProvider=sqlserver" \
          -d "ServerName=localhost" \
          -d "DatabaseName=nopCommerce" \
          -d "IntegratedSecurity=false" \
          -d "Username=sa" \
          -d "Password=Can@922946" \
          -d "TrustServerCertificate=true" \
          -d "CreateSampleData=true" \
          -d "AdminEmail=admin@yourstore.com" \
          -d "AdminPassword=admin123" \
          -d "ConfirmPassword=admin123" \
          -d "InstallSampleData=true"
        
        echo "Installation triggered. Waiting for completion..."

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Wait for Installation Complete
      run: |
        echo "Waiting for nopCommerce installation (2-4 minutes)..."
        
        for i in {1..40}; do
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:80)
          
          # Status 200 = installation complete
          if [ "$STATUS" == "200" ]; then
            if curl -s http://localhost:80 | grep -q "ico-register"; then
              echo "✅ SUCCESS: nopCommerce is ready!"
              exit 0
            fi
          fi
          
          # Status 302 = still on install wizard (normal during installation)
          echo "[$i/40] Status: $STATUS (waiting...)"
          sleep 15
        done
        
        echo "❌ Installation timeout. Logs:"
        docker logs nop_app --tail 50
        exit 1

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80

# THÊM ĐOẠN NÀY VÀO CUỐI FILE
    - name: Upload Playwright report
      if: always() # Luôn chạy kể cả khi test fail
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: test-results/ # Hoặc playwright-report/ tùy cấu hình của bạn
        retention-days: 7