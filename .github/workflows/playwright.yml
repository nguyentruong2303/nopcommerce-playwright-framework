name: Playwright Tests
on:
  push:
    branches: [ main, master, fix-ci]
  pull_request:
    branches: [ main, master, fix-ci]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Pre-create Database
      run: |
        sleep 20
        docker exec $(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest") /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "Can@922946" -Q "CREATE DATABASE [nopCommerce];" -C

    - name: Run nopCommerce with Injected Config
      run: |
        # 1. Tạo thư mục chứa config trên runner
        mkdir -p $(pwd)/nop_data
        
        # 2. Tạo file dataSettings.json chuẩn
        # Lưu ý: Dùng 'host.docker.internal' hoặc '127.0.0.1' tùy theo network mode
        cat <<EOF > $(pwd)/nop_data/dataSettings.json
        {
          "DbConnectionString": "Server=127.0.0.1,1433;Database=nopCommerce;User ID=sa;Password=Can@922946;TrustServerCertificate=True;Encrypt=False",
          "DataProvider": "sqlserver",
          "SQLCommandTimeout": null
        }
        EOF
        
        # 3. Cấp quyền đọc/ghi tuyệt đối cho thư mục này
        chmod -R 777 $(pwd)/nop_data

        # 4. Chạy Docker và MOUNT file vào đúng vị trí App_Data
        # Sử dụng --network host để App nhìn thấy SQL Server ở localhost
        docker run -d \
          --name nop_app \
          --network host \
          -v $(pwd)/nop_data/dataSettings.json:/app/App_Data/dataSettings.json \
          -e ASPNETCORE_ENVIRONMENT=Production \
          nopcommerceteam/nopcommerce:latest

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Wait for App ready
      run: |
        echo "Waiting for nopCommerce to bypass Install page..."
        # Đợi 60s để App thực hiện Migration (tạo bảng) ngầm
        sleep 60
        
        for i in {1..30}; do
          # Kiểm tra xem trang web đã thoát khỏi màn hình Install chưa bằng cách tìm nút Đăng ký
          RESPONSE=$(curl -sL http://localhost:80)
          
          if echo "$RESPONSE" | grep -q "ico-register"; then
            echo "SUCCESS: Homepage is LIVE and bypass Install page!"
            exit 0
          fi
          
          if echo "$RESPONSE" | grep -q "installation"; then
            echo "Attempt $i: Still stuck on Install page. Checking logs..."
            docker logs nop_app --tail 10
          else
            echo "Attempt $i: Page is loading or migrating..."
          fi
          sleep 15
        done
        
        echo "FAILED: Final UI check failed. Container Logs:"
        docker logs nop_app
        exit 1

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80

# THÊM ĐOẠN NÀY VÀO CUỐI FILE
    - name: Upload Playwright report
      if: always() # Luôn chạy kể cả khi test fail
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: test-results/ # Hoặc playwright-report/ tùy cấu hình của bạn
        retention-days: 7