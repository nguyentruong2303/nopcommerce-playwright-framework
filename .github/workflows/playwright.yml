name: Playwright Tests
on:
  push:
    branches: [ main, master, fix-ci]
  pull_request:
    branches: [ main, master, fix-ci]

jobs:
  test:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: "Can@922946"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433

    steps:
    - uses: actions/checkout@v4

    - name: Pre-create Database
      run: |
        sleep 20
        docker exec $(docker ps -qf "ancestor=mcr.microsoft.com/mssql/server:2022-latest") /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "Can@922946" -Q "CREATE DATABASE [nopCommerce];" -C

    - name: Run nopCommerce (Manual Config Injection)
      run: |
        # 1. Chạy container trước
        docker run -d --name nop_app --network host nopcommerceteam/nopcommerce:latest
        
        # 2. Tạo file cấu hình dataSettings.json chuẩn
        mkdir -p temp_data
        cat <<EOF > temp_data/dataSettings.json
        {
          "DbConnectionString": "Server=localhost,1433;Database=nopCommerce;User ID=sa;Password=Can@922946;TrustServerCertificate=True;Encrypt=False",
          "DataProvider": "sqlserver",
          "SQLCommandTimeout": null
        }
        EOF

        # 3. Đợi App khởi động 1 chút rồi chép file vào App_Data
        sleep 10
        docker cp temp_data/dataSettings.json nop_app:/app/App_Data/dataSettings.json
        
        # 4. Quan trọng: Cấp quyền ghi cho thư mục để App tự chạy Migration
        docker exec -u root nop_app chmod -R 777 /app/App_Data
        
        # 5. Khởi động lại để App nhận cấu hình mới
        docker restart nop_app

    - name: Setup Node & Playwright
      run: |
        npm install -g pnpm
        pnpm install
        pnpm exec playwright install --with-deps chromium

    - name: Wait for App ready
      run: |
        echo "Waiting for nopCommerce to migrate database and show Homepage..."
        # Quá trình tạo bảng lần đầu mất khoảng 1-2 phút
        sleep 60
        timeout 300 bash -c 'until curl -sL http://localhost:80 | grep -q "ico-register"; do echo "Still on Install page or loading... waiting 10s"; sleep 10; done'
        echo "SUCCESS: Homepage is LIVE!"

    - name: Run Playwright tests
      run: pnpm exec playwright test
      env:
        BASE_URL: http://localhost:80

# THÊM ĐOẠN NÀY VÀO CUỐI FILE
    - name: Upload Playwright report
      if: always() # Luôn chạy kể cả khi test fail
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: test-results/ # Hoặc playwright-report/ tùy cấu hình của bạn
        retention-days: 7